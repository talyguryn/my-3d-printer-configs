# ============================================================================
# ENDER 3 + KLIPPER + PETG - MASTER CONFIGURATION BUNDLE
# ============================================================================
# Generated: 2026-01-18
# Version: 2.0 - Optimized for Input Shaper & Direct Drive
#
# Структура конфига:
# 1. PRINTER PROFILE - одна база для принтера
# 2. FILAMENT PROFILES - несколько типов пластика
# 3. PRINT PROFILES - несколько режимов печати (QUALITY, BALANCED, SPEED)
# 4. MATERIAL + MODE COMBINATIONS - готовые пресеты
#
# Как использовать:
# - Выбирайте нужный filament profile + print profile
# - Или используйте готовый пресет (PETG_Quality, PETG_Balanced и т.д.)
# - Новые филаменты/режимы легко добавляются копированием секции
# ============================================================================


# ============================================================================
# DEFAULT PROFILES
# ============================================================================
default_print_profile = PETG_Black_Balanced
default_filament_profile = PETG_Black
print_settings_id = PETG_Black_Balanced
printer_settings_id = Ender3_DD_Klipper


# ============================================================================
# NOTES FOR FUTURE ENHANCEMENTS
# ============================================================================
# TODO: После Input Shaper калибровки
#   - Обновить max_print_speed в SPEED профиле до 250-300 мм/с
#   - Рассмотреть увеличение default_acceleration до 5000
#   - Добавить Input Shaper параметры в каждый профиль
#
# TODO: При добавлении новых филаментов
#   - Скопировать блок [filament:PETG_Black]
#   - Заменить имя и параметры (особенно temperature и bed_temperature)
#   - Создать новые преsets в SECTION 4
#
# TODO: Когда будет известна точная калибровка Pressure Advance
#   - Добавить pressure_advance в каждый [filament:...] профиль
#   - Или переместить в START_PRINT макрос (уже реализовано)
#
# TODO: Для специальных режимов печати
#   - Создать [print:HighDetail] для маленьких моделей
#   - Создать [print:FunctionallPart] для максимальной прочности


# ============================================================================
# SECTION 1: PRINTER PROFILE
# ============================================================================
# Одна база для всех режимов - данные из printer.cfg Klipper
[printer:Ender3_DD_Klipper]

printer_model = Ender 3
printer_technology = FFF
printer_variant = 0.4
printer_notes = SKR Mini E3 V3.0 + Klipper + BMG Direct Drive + BLTouch + Dual Z
nozzle_diameter = 0.4
threads = 36

# BUILD VOLUME (из printer.cfg)
bed_shape = 0x20,225x20,225x235,0x235
max_print_height = 250

# MACHINE LIMITS (из printer.cfg: max_velocity: 300, max_accel: 4000)
machine_limits_usage = ignore
machine_max_feedrate_x = 300
machine_max_feedrate_y = 300
machine_max_feedrate_z = 15
machine_max_feedrate_e = 100
machine_max_acceleration_x = 4000
machine_max_acceleration_y = 4000
machine_max_acceleration_z = 150
machine_max_acceleration_extruding = 4000
machine_max_acceleration_retracting = 1200
machine_max_acceleration_travel = 4000
machine_max_acceleration_e = 3000
machine_max_jerk_x = 8
machine_max_jerk_y = 8
machine_max_jerk_z = 2
machine_max_jerk_e = 10
machine_min_extruding_rate = 0
machine_min_travel_rate = 0

# GCODE & FIRMWARE
gcode_flavor = klipper
use_relative_e_distances = 0
use_volumetric_e = 0
gcode_resolution = 0.0125
gcode_comments = 0
gcode_label_objects = 1

# START/END GCODE - вызывают макросы из printer.cfg Klipper
start_gcode = SET_PRINT_STATS_INFO TOTAL_LAYER=[total_layer_count]\nSTART_PRINT BED={first_layer_bed_temperature[0]} EXTRUDER={first_layer_temperature[0]}
start_filament_gcode = "SET_PRESSURE_TUNING K={if nozzle_diameter[0]==0.4}0.07{elsif nozzle_diameter[0]==0.25}0.12{elsif nozzle_diameter[0]==0.3}0.09{elsif nozzle_diameter[0]==0.35}0.08{elsif nozzle_diameter[0]==0.6}0.04{elsif nozzle_diameter[0]==0.5}0.05{elsif nozzle_diameter[0]==0.8}0.02{else}0{endif}\n\nSET_HEATBREAK_COOLING TEMP=36"
end_gcode = END_PRINT
layer_gcode = SET_PRINT_STATS_INFO CURRENT_LAYER={layer_num + 1}
before_layer_gcode =
between_objects_gcode =
toolchange_gcode =
color_change_gcode = PAUSE
pause_print_gcode = PAUSE
colorprint_heights =

# OUTPUT & CONNECTIVITY
output_filename_format = {input_filename_base}_{layer_height}mm_{printing_filament_types}_{print_time}.gcode
thumbnails = 32x32/PNG, 300x300/PNG
thumbnails_format = PNG

# ============================================================================
# PHYSICAL PRINTER SETTINGS FOR PRINT HOST
# ============================================================================
[physical_printer:Local]
host_type = moonraker
preset_name = Ender3_DD_Klipper
preset_names = Ender3_DD_Klipper
print_host = 192.168.31.76
printer_technology = FFF
printhost_apikey =
printhost_authorization_type = key
printhost_cafile =
printhost_password =
printhost_port =
printhost_ssl_ignore_revoke = 0
printhost_user =

# ============================================================================
# SECTION 2: FILAMENT PROFILES
# ============================================================================

# --- PETG BLACK (основной) ---
[filament:PETG_Black]
filament_type = PETG
filament_vendor = Generic
filament_settings_id = PETG_Black_DD
filament_diameter = 1.75
filament_density = 1.33
filament_colour = #454545
filament_cost = 1000

temperature = 230
first_layer_temperature = 230
bed_temperature = 70
first_layer_bed_temperature = 70

# FILAMENT ADVANCED (для Klipper macros)
filament_max_volumetric_speed = 12
filament_loading_speed = 14
filament_loading_speed_start = 19
filament_unloading_speed = 20
filament_unloading_speed_start = 120
filament_load_time = 15
filament_unload_time = 12

# COOLING & FAN
fan_always_on = 0
disable_fan_first_layers = 4
max_fan_speed = 50

# PRESSURE ADVANCE (calibrated)
# Базовое значение для Direct Drive: 0.07
# Будет переопределено в START_PRINT через SET_PRESSURE_TUNING

# ============================================================================
# --- PETG WHITE ---
# ============================================================================
[filament:PETG_White]
filament_type = PETG
filament_vendor = Generic
filament_settings_id = PETG_White_DD
filament_colour = #FFFFFF

temperature = 230
first_layer_temperature = 230
bed_temperature = 70
first_layer_bed_temperature = 70
filament_diameter = 1.75
filament_density = 1.33
filament_max_volumetric_speed = 12
fan_always_on = 0
disable_fan_first_layers = 4
max_fan_speed = 50

# ============================================================================
# --- PETG ORANGE ---
# ============================================================================
[filament:PETG_Orange]
filament_type = PETG
filament_vendor = Generic
filament_settings_id = PETG_Orange_DD
filament_colour = #FF8400

temperature = 230
first_layer_temperature = 230
bed_temperature = 70
first_layer_bed_temperature = 70
filament_diameter = 1.75
filament_density = 1.33
filament_max_volumetric_speed = 12
fan_always_on = 0
disable_fan_first_layers = 4
max_fan_speed = 50

# ============================================================================
# SECTION 3: PRINT PROFILES
# ============================================================================
# Три режима печати на выбор:
# - QUALITY: максимальное качество, медленнее
# - BALANCED: баланс качества и скорости
# - SPEED: максимальная скорость, приемлемое качество
#
# Все согласованы с printer.cfg (max_accel: 4000)
# Готовы к Input Shaper (будет улучшать результаты дальше)

# ============================================================================
# --- PRINT PROFILE: BALANCED ---
# ============================================================================
# Приоритет: Качество 60% / Скорость 40%
# Когда использовать: Большинство деталей, универсальный режим
# Время печати: базовое (эталон)
[print:Balanced]

# LAYER & HEIGHT SETTINGS
layer_height = 0.2
first_layer_height = 0.28
min_layer_height = 0.05
max_layer_height = 0.28

# PERIMETERS
perimeters = 2
external_perimeters_first = 0

# # SPEEDS - оптимальные для Input Shaper
# first_layer_speed = 30
# perimeter_speed = 100
# external_perimeter_speed = 70
# small_perimeter_speed = 60

# infill_speed = 150
# solid_infill_speed = 120
# gap_fill_speed = 60
# top_solid_infill_speed = 100

# travel_speed = 250
# travel_speed_z = 10
# deretract_speed = 30
# retract_speed = 30

# bridge_speed = 60
# max_print_speed = 180
# min_print_speed = 15

# SPEEDS - оптимальные для Input Shaper
first_layer_speed = 30
perimeter_speed = 60
external_perimeter_speed = 60
small_perimeter_speed = 60

infill_speed = 60
solid_infill_speed = 60
gap_fill_speed = 60
top_solid_infill_speed = 60

travel_speed = 200
travel_speed_z = 10
deretract_speed = 30
retract_speed = 30

bridge_speed = 60
max_print_speed = 180
min_print_speed = 15

# Overhang speeds
overhang_speed_0 = 25
overhang_speed_1 = 35
overhang_speed_2 = 50
overhang_speed_3 = 60

# ACCELERATIONS
default_acceleration = 3000
first_layer_acceleration = 1000
infill_acceleration = 2000
perimeter_acceleration = 1500
external_perimeter_acceleration = 1000
top_solid_infill_acceleration = 1500
solid_infill_acceleration = 1500
bridge_acceleration = 1000

# RETRACTIONS
retract_length = 1.0
retract_lift = 0.2
retract_lift_above = 0
retract_lift_below = 250
retract_before_travel = 2
retract_before_wipe = 100%
retract_layer_change = 0
retract_restart_extra = 0

# INFILL & SOLID
fill_density = 5%
fill_pattern = gyroid
bottom_solid_layers = 3
bottom_solid_min_thickness = 0.8
top_solid_layers = 5
top_solid_min_thickness = 0.8
bottom_fill_pattern = rectilinear
top_fill_pattern = monotonic

# COOLING & FANS
cooling = 1
fan_always_on = 0
disable_fan_first_layers = 4
min_fan_speed = 0
max_fan_speed = 50
fan_below_layer_time = 20
bridge_fan_speed = 100

# SEAMS & FEATURES
seam_position = aligned
gap_fill_enabled = 1
thin_walls = 0
spiral_vase = 0

# SUPPORTS
support_material = 1
support_material_auto = 0
support_material_style = organic
support_material_pattern = rectilinear
support_material_spacing = 2.5
support_material_angle = 0
support_material_threshold = 35
support_material_enforce_layers = 0
support_material_contact_distance = 0.15
support_material_xy_spacing = 80%
dont_support_bridges = 1
support_material_interface_layers = 3

# Skirt & Brim
skirts = 3
skirt_distance = 6
skirt_height = 1

# Extrusion Widths
extrusion_width = 0.5
first_layer_extrusion_width = 0.8
perimeter_extrusion_width = 0.4
external_perimeter_extrusion_width = 0.4
infill_extrusion_width = 0.5
solid_infill_extrusion_width = 0.5
top_infill_extrusion_width = 0.5
support_material_extrusion_width = 0.4

# ============================================================================
# SECTION 4: READY-TO-USE PRESETS
# ============================================================================
# Копируйте этот пресет при добавлении новой комбинации
# Пример:
# [print:PETG_Black_Quality]
# inherits = PETG_Quality
# default_filament_profile = PETG_Black
# print_settings_id = PETG_Black_Quality
#
# Или если хотите полностью переопределить - копируйте полную секцию [print:...]

# Spiral Vase Mode
[print:Spiral_Vase]
inherits = Balanced
spiral_vase = 1